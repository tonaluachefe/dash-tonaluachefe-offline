<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Home - Offline</title>

    <link rel="stylesheet" href="assets/css/site-base.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

    <div class="app">

        <!-- SIDEBAR -->
        <div class="sidebar">
            <a href="index.html" class="active">Home</a>
            <a href="airdrops.html">My Airdrops</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="pools.html">Pools</a>
            <a href="stakes.html">Stakes</a>
            <a href="wallets.html">Wallets</a>
            <a href="tarefas.html">Tasks</a>
            <a href="collection.html">Collection</a>
            <a href="feedback.html">Feedback</a>
            <a href="admin.html" style="color:#3b82f6;">Admin</a>
            <a href="#" onclick="UserManager.logout(); return false;" style="color:#ef4444;">Logout</a>
        </div>

        <!-- CONTE√öDO PRINCIPAL -->
        <div class="main">
            <h1>Home</h1>

            <!-- NFT Collection Info -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 24px;">
                <h2 style="margin-top: 0;">NFT Collection Access</h2>
                <p style="margin-bottom: 16px; opacity: 0.9;">
                    <strong>Important:</strong> Users registered after <strong>January 2, 2026</strong> must have at least <strong>1 NFT</strong> from the collection in their wallet to access the platform.
                </p>
                <p style="margin-bottom: 16px; opacity: 0.9;">
                    Visit the <a href="collection.html" style="color: #86efac; text-decoration: underline;">Collection</a> page to mint your NFT and view the entire collection.
                </p>
                <div id="nft-status" style="margin-top: 16px;"></div>
            </div>

            <!-- Calendar -->
            <div class="card" style="padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #fff; display: flex; align-items: center; gap: 10px;">
                        <span>üìÖ</span>
                        <span id="calendar-month-year"></span>
                    </h2>
                    <div style="display: flex; gap: 8px;">
                        <button id="prev-month" style="padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; cursor: pointer; font-weight: 500;">‚Üê Prev</button>
                        <button id="today-btn" style="padding: 8px 16px; border-radius: 6px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; cursor: pointer; font-weight: 500;">Today</button>
                        <button id="next-month" style="padding: 8px 16px; border-radius: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #3b82f6; cursor: pointer; font-weight: 500;">Next ‚Üí</button>
                    </div>
                </div>
                
                <div id="calendar-container" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;">
                    <!-- Calendar will be generated here -->
                </div>
                
                <div id="calendar-tasks" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="margin: 0 0 12px 0; color: #fff; font-size: 16px;">Tasks for Selected Date</h3>
                    <div id="selected-date-tasks" style="color: var(--muted);">
                        Click on a date to see tasks
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="assets/js/js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/nft.js"></script>
    <script>
        // Proteger rota
        (async () => {
            if (!await requireAuth()) {
                return;
            }
            checkNFTStatus();
        })();

        async function checkNFTStatus() {
            const user = UserManager.getCurrentUser();
            if (!user) return;

            const accessCheck = await NFTManager.verifyUserAccess(user);
            const statusDiv = document.getElementById('nft-status');

            if (accessCheck.hasAccess) {
                if (accessCheck.reason === 'has_nft') {
                    const userNFTs = NFTManager.getUserNFTs(user.id);
                    statusDiv.innerHTML = `
                        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 8px; padding: 12px;">
                            <strong style="color: #86efac;">‚úì Access Granted</strong><br>
                            You have ${userNFTs.length} NFT(s) in your collection. Platform access is active.
                        </div>
                    `;
                } else if (accessCheck.reason === 'legacy_user') {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 8px; padding: 12px;">
                            <strong style="color: #86efac;">‚úì Legacy User</strong><br>
                            You are registered before January 2, 2026. NFT not required for access.
                        </div>
                    `;
                } else if (accessCheck.reason === 'admin') {
                    statusDiv.innerHTML = `
                        <div style="background: rgba(34, 197, 94, 0.2); border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 8px; padding: 12px;">
                            <strong style="color: #86efac;">‚úì Admin Access</strong><br>
                            You have administrator privileges. NFT not required.
                        </div>
                    `;
                }
            } else {
                statusDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 8px; padding: 12px;">
                        <strong style="color: #fca5a5;">‚ö† NFT Required</strong><br>
                        ${accessCheck.message || 'You need at least 1 NFT from the collection to access the platform. Please mint an NFT on the Collection page.'}
                    </div>
                `;
            }
        }
    </script>
    <script src="assets/js/app.js"></script>
    <script>
        // Calendar functionality
        (() => {
            const calendarContainer = document.getElementById('calendar-container');
            const monthYearElement = document.getElementById('calendar-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const todayBtn = document.getElementById('today-btn');
            const selectedDateTasks = document.getElementById('selected-date-tasks');

            if (!calendarContainer) return;

            let currentDate = new Date();
            let selectedDate = null;

            // Helper functions
            const getAirdrops = () => JSON.parse(localStorage.getItem('airdrops') || '[]');
            const getTasks = (airdropId) => JSON.parse(localStorage.getItem(`tasks-${airdropId}`) || '[]');
            
            function getAllTasks() {
                const airdrops = getAirdrops();
                const allTasks = [];
                airdrops.forEach(a => {
                    const tasks = getTasks(a.id);
                    tasks.forEach(t => {
                        allTasks.push({ ...t, airdropId: a.id, airdropName: a.name });
                    });
                });
                return allTasks;
            }

            function getTasksByDate(date) {
                const allTasks = getAllTasks();
                const dateStr = date.toISOString().split('T')[0];
                return allTasks.filter(task => {
                    if (!task.scheduledAt) return false;
                    const taskDate = new Date(task.scheduledAt);
                    const taskDateStr = taskDate.toISOString().split('T')[0];
                    return taskDateStr === dateStr;
                });
            }

            function getDaysWithTasks(year, month) {
                const allTasks = getAllTasks();
                const daysWithTasks = new Set();
                allTasks.forEach(task => {
                    if (!task.scheduledAt) return;
                    const taskDate = new Date(task.scheduledAt);
                    if (taskDate.getFullYear() === year && taskDate.getMonth() === month) {
                        daysWithTasks.add(taskDate.getDate());
                    }
                });
                return daysWithTasks;
            }

            function renderCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                // Update month/year display
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                monthYearElement.textContent = `${monthNames[month]} ${year}`;

                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysWithTasks = getDaysWithTasks(year, month);
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

                // Clear container
                calendarContainer.innerHTML = '';

                // Day headers
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.style.cssText = 'padding: 12px; text-align: center; font-weight: bold; color: var(--muted); font-size: 13px;';
                    header.textContent = day;
                    calendarContainer.appendChild(header);
                });

                // Empty cells for days before month starts
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    empty.style.cssText = 'padding: 12px; min-height: 60px;';
                    calendarContainer.appendChild(empty);
                }

                // Days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const cellDate = new Date(year, month, day);
                    const isSelected = selectedDate && 
                                      selectedDate.getDate() === day && 
                                      selectedDate.getMonth() === month && 
                                      selectedDate.getFullYear() === year;
                    const isToday = isCurrentMonth && day === today.getDate();
                    const hasTasks = daysWithTasks.has(day);

                    dayCell.style.cssText = `
                        padding: 12px;
                        min-height: 60px;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: ${isSelected ? 'rgba(59, 130, 246, 0.3)' : isToday ? 'rgba(59, 130, 246, 0.1)' : 'transparent'};
                        position: relative;
                    `;

                    dayCell.innerHTML = `
                        <div style="font-weight: ${isToday ? 'bold' : 'normal'}; color: ${isToday ? '#3b82f6' : '#fff'}; margin-bottom: 4px;">
                            ${day}
                        </div>
                        ${hasTasks ? '<div style="font-size: 10px; color: #10b981;">‚óè</div>' : ''}
                    `;

                    dayCell.addEventListener('click', () => {
                        selectedDate = cellDate;
                        renderCalendar();
                        showTasksForDate(cellDate);
                    });

                    dayCell.addEventListener('mouseenter', () => {
                        if (!isSelected) {
                            dayCell.style.background = 'rgba(255, 255, 255, 0.05)';
                        }
                    });

                    dayCell.addEventListener('mouseleave', () => {
                        if (!isSelected) {
                            dayCell.style.background = isToday ? 'rgba(59, 130, 246, 0.1)' : 'transparent';
                        }
                    });

                    calendarContainer.appendChild(dayCell);
                }
            }

            function showTasksForDate(date) {
                const tasks = getTasksByDate(date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                if (tasks.length === 0) {
                    selectedDateTasks.innerHTML = `
                        <div style="color: var(--muted); padding: 20px; text-align: center;">
                            No tasks scheduled for <strong>${dateStr}</strong>
                        </div>
                    `;
                    return;
                }

                let html = `<div style="color: #fff; margin-bottom: 12px; font-weight: 500;">Tasks for <strong>${dateStr}</strong> (${tasks.length}):</div>`;
                html += '<div style="display: grid; gap: 12px;">';
                
                tasks.forEach(task => {
                    const frequencyColors = {
                        '√önica': '#ec4899',
                        'Di√°ria': '#06b6d4',
                        'Semanal': '#f59e0b',
                        'Mensal': '#8b5cf6'
                    };
                    const freqColor = frequencyColors[task.frequency] || '#6b7280';
                    const timeStr = task.scheduledAt ? new Date(task.scheduledAt).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) : 'No time set';

                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 6px; border-left: 3px solid ${freqColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 500; color: #fff; margin-bottom: 4px;">${task.name || 'Unnamed Task'}</div>
                                    <div style="font-size: 12px; color: var(--muted);">${task.airdropName || 'Unknown Airdrop'}</div>
                                </div>
                                <span style="background: ${freqColor}; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #fff;">${task.frequency || '√önica'}</span>
                            </div>
                            ${task.description ? `<div style="font-size: 13px; color: var(--muted); margin-top: 8px;">${task.description}</div>` : ''}
                            <div style="font-size: 12px; color: var(--muted); margin-top: 8px;">üïê ${timeStr}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                selectedDateTasks.innerHTML = html;
            }

            // Event listeners
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                selectedDate = null;
                renderCalendar();
                selectedDateTasks.innerHTML = '<div style="color: var(--muted);">Click on a date to see tasks</div>';
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                selectedDate = null;
                renderCalendar();
                selectedDateTasks.innerHTML = '<div style="color: var(--muted);">Click on a date to see tasks</div>';
            });

            todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                selectedDate = new Date();
                renderCalendar();
                showTasksForDate(selectedDate);
            });

            // Initialize calendar
            renderCalendar();
        })();
    </script>
</body>

</html>
